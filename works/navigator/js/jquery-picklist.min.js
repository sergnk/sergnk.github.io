(function ($) {

   $.fn.pickList = function (options) {

      var opts = $.extend({}, $.fn.pickList.defaults, options);

      this.controll = function () {
         var pickThis = this;

         pickThis.find(".js-pAdd").on('click', function () {
            var p = pickThis.find(".pickData option:selected");
            p.clone().appendTo(pickThis.find(".pickListResult"));
            pickThis.find(".pickListResult").trigger("chosen:updated").trigger('chosen:open').addClass('changed');
            p.remove();
            pickThis.find(".js-select-start").trigger("chosen:updated").trigger('chosen:open');
            return false;
         });

         pickThis.find(".pAddAll").on('click', function () {
            var p = pickThis.find(".pickData option");
            p.clone().appendTo(pickThis.find(".pickListResult"));
            pickThis.find(".pickListResult").trigger("chosen:updated").trigger('chosen:open').addClass('changed');
            p.remove();
            pickThis.find(".js-select-start").trigger("chosen:updated").trigger('chosen:open');
            return false;
         });

         pickThis.find(".js-pRemove").on('click', function () {
            var p = pickThis.find(".pickListResult option:selected");
            p.clone().removeAttr('selected').appendTo(pickThis.find(".pickData"));
           pickThis.find(".js-select-start").trigger("chosen:updated").trigger('chosen:open');
            p.remove();
            pickThis.find(".pickListResult").trigger("chosen:updated").trigger('chosen:open');
            if (pickThis.find('.pickListResult option').size() > 0) {
               pickThis.find('.pickListResult').addClass('changed');
            } else {
               pickThis.find('.pickListResult').removeClass('changed');
            }
            return false;
         });

         pickThis.find(".js-deselect-all").on('click', function () {
            var p = pickThis.find(".pickListResult option");
            p.clone().removeAttr('selected').appendTo(pickThis.find(".pickData"));
            pickThis.find(".js-select-start").trigger("chosen:updated").trigger('chosen:open');
            p.remove();
            pickThis.find(".pickListResult").trigger("chosen:updated").trigger('chosen:open').removeClass('changed');
            return false;
         });
         pickThis.find(".pickListResult").on('change', function(){
            if(pickThis.find(".pickListResult").is('.changed') && !pickThis.closest('.b-form-select-line').is('.open')) {
               var p = pickThis.find(".pickListResult option").not(':selected');
               p.clone().removeAttr('selected').appendTo(pickThis.find(".pickData"));
               pickThis.find(".js-select-start").trigger("chosen:updated").trigger('chosen:open');
               p.remove(); 
               pickThis.find(".pickListResult").trigger("chosen:updated");
            }
         })
      };

      this.getValues = function () {
         var objResult = [];
         this.find(".pickListResult option").each(function () {
            objResult.push({
               id: $(this).data('id'),
               text: this.text
            });
         });
         return objResult;
      };

      this.init = function () {


         this.controll();
      };

      this.init();
      return this;
   };
}(jQuery));
